import os, sys, array
from bottle import response, route, run, static_file, template
from ethjsonrpc import EthJsonRpc

geth = EthJsonRpc('127.0.0.1', 8545)
print "blockNumber: ", geth.eth_blockNumber()

# TODO calculate from parameters
paymentHash = "0011223344556677889900112233445566778899001122334455667788990011";
paymentHashHex = paymentHash.decode("hex");

# You need to change this deployed address whenever it changes
deployedMasterPay = u'0x3bd2b739aa327d8bab879d9767468082f9ad0cac';

# You need to change this binary whenever it changes.
productPaymentCompiled = '606060405260405160608061052783395060c06040525160805160a05160008054600160a060020a031916331790556000341115603a576002565b8260016000508190555081600260006101000a815481600160a060020a03021916908302179055508042016003600050819055505050506104a88061007f6000396000f36060604052361561008d5760e060020a600035046313af403581146100a45780631c31f710146100c7578063209ebc08146100eb57806338af3eed146100f75780633cb5d1001461010957806342e94c901461014f5780635a9e426b14610167578063614d85e11461017a5780638da5cb5b14610183578063a035b1fe14610195578063feed55611461019e575b6101b160004260036000505410156101b357610002565b6101b1600435600054600160a060020a039081163391909116146103bf57610002565b61039660043560008054600160a060020a0390811633919091161461040457610002565b61039660045460ff1681565b6103a2600254600160a060020a031681565b6103a260043560068054829081101561000257506000527ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0154600160a060020a031681565b6103b560043560056020526000908152604090205481565b6101b160045460ff161561043b57610002565b6103b560035481565b6103a2600054600160a060020a031681565b6103b560015481565b6103b5600060003411156104a157610002565b005b60045460ff16156101c357610002565b34600014156101d157610002565b600160a060020a033316815260056020526040812054811415610252576006805460018101808355828183801582901161022d5781836000526020600020918201910161022d91905b8082111561029b5788815560010161021a565b505050919090600052602060002090016000508054600160a060020a03191633179055505b60015430600160a060020a031631111561029f5760015430600160a060020a03908116319190910391339091169082606082818181858883f19350505050151561034f57610002565b5090565b346005600050600033600160a060020a031681526020019081526020016000206000828282505401925050819055505b60015460405130600160a060020a031631909103907f29c58739386c24a49b236b2e19b44c551a07b52ff22ecb5634ccb6142b821bfe90600090a260015430600160a060020a031631141561039357604051600254600160a060020a03908116916000913016319082818181858883f19350505050151561038557610002565b8034036005600050600033600160a060020a031681526020019081526020016000206000828282505401925050819055506102cf565b6004805460ff191660011790555b50565b15156060908152602090f35b600160a060020a03166060908152602090f35b6060908152602090f35b60008054600160a060020a0319168217808255600160a060020a0316907f161bb793d692b306bdd3dc91c229acd89bd7df521bf12f3ce85e28509347c787906060a250565b60045460ff161561041457610002565b600034111561042257610002565b5060028054600160a060020a0319169091179055600190565b600034111561044957610002565b600160a060020a033316600081815260056020526040812054606082818181858883f193505050501561049f5760006005600050600033600160a060020a03168152602001908152602001600020600050819055505b565b506006549056'

@route('/values.js')
def myHash():
	currentCount = geth.call(deployedMasterPay, 'getProductPaymentIdHashesCount()', [], ['uint256'])[0];
	print "currentCount: ", currentCount
	firstHash = geth.call(deployedMasterPay, 'productPaymentIdHashes(uint256)', [0], ['bytes32'])
	print "firstHash: "
	print firstHash
	currentPayment = None
	currentPayment = geth.call(deployedMasterPay, 'productPayments(bytes32)', [paymentHashHex], ['bytes32', 'address', 'uint256', 'bool'])
	print currentPayment
	if currentPayment[3]:
		paymentAddress = currentPayment[1]
		contractTx = "0x0"
	else:
		paymentAddress = "0x0"
		contractTx = geth.create_contract(geth.eth_coinbase(), productPaymentCompiled, gas=300000)

	response.content_type = 'text/javascript'
	return '\
var paymentHash="0x' + paymentHash + '";\n\
var deployedMasterPay="' + deployedMasterPay + '";\n\
var contractCreateTxn="' + contractTx + '";\n\
var paymentAddress="0x' + paymentAddress + '";\n\
$(window).load(function () {\n\
  $("#paymentHash").html(paymentHash);\n\
  $("#deployedMasterPay").html(deployedMasterPay);\
  $("#createTransaction").html(contractCreateTxn);\n\
  $("#paymentAddress").html(paymentAddress);\n\
});\
'

# @route('/hello/<name>')
# def index(name):
#     return template('<b>Hello {{name}}</b>!', name=name)

# Serving files created via Truffle.
@route('/<filepath:path>')
def server_static(filepath):
    dirname = os.path.dirname(__file__)
    return static_file(filepath, root=dirname + '/build')

run(host='0.0.0.0', port=8000)
